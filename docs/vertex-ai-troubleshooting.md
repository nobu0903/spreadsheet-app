# Vertex AI エラー原因分析と解決策

## 1. なぜ Vertex AI Studio では動作するのに、ローカル実行ではエラーが出るのか

### Vertex AI Studio の動作
- **モデルエイリアスを使用**: `gemini-1.5-flash` というエイリアスが自動的に最新の利用可能なバージョンに解決される
- **バックエンドでモデル解決**: Google側が自動的に適切なバージョン番号を付与してリクエストを処理
- **ユーザーはエイリアスのみ指定**: バージョン管理の複雑さを隠蔽

### ローカル実行（REST API直接呼び出し）の問題
- **明示的なモデル指定が必要**: REST APIでは完全なモデルリソース名が必要
- **バージョン番号の不一致**: `-001` というサフィックスは実際のモデルバージョンと一致しない可能性が高い
- **エイリアスの解決ができない**: REST APIでは自動的にエイリアスを解決する機能がない

### 因果関係
```
Vertex AI Studio → エイリアス解決 → 最新バージョン (例: gemini-1.5-flash-002) → 成功
ローカルREST API → 固定バージョン指定 (gemini-1.5-flash-001) → 存在しない → 404エラー
```

## 2. エラーの本質的な原因

### 設定の観点
- **モデル名の指定方法**: エイリアスとバージョン指定の違いを理解していない
- **環境変数の値**: `.env`で指定している値がREST APIで使用できない形式

### SDKの観点
- **googleapis を使用**: 低レベルのREST API呼び出しのため、モデル名の解決が自動化されていない
- **@google-cloud/vertexai SDKとの違い**: SDKを使用していればエイリアス解決が自動化されるが、今回はREST APIを直接使用

### モデル指定の観点
- **誤った仮定**: `-001` が常に正しいバージョン番号だという仮定
- **実際のバージョン**: Vertex AIではバージョン番号が `-002`, `-003` などに更新されることがある

### 実行環境の観点
- **Cursor（ローカル）**: REST APIを直接呼び出すため、モデル名の完全な指定が必要
- **Vertex AI Studio（ブラウザ）**: Google側のバックエンドがエイリアスを解決

## 3. Cursorで開発する場合の正しいアプローチ

### 推奨アプローチ: モデルエイリアスを使用
Vertex AI REST APIでは、特定のエンドポイントでモデルエイリアスがサポートされています。
- `gemini-1.5-flash` (エイリアス、最新バージョン)
- `gemini-1.5-pro` (エイリアス、最新バージョン)

### 代替アプローチ: @google-cloud/vertexai SDK を使用
SDKを使用すれば、エイリアスの自動解決が行われるため、Vertex AI Studioと同様の動作が期待できます。

### 考え方
1. **エイリアスを優先**: バージョン番号を固定せず、エイリアスを使用する
2. **明示的バージョン指定は避ける**: モデルの更新に対応できなくなる
3. **SDK vs REST API**: できるだけSDKを使用する（ただし、今回はREST APIで実装）

## 4. 修正すべき具体的ポイント（優先度順）

### 【最優先】モデル名の指定方法を変更
- 現在: `gemini-1.5-flash-001` (存在しないバージョン)
- 修正: `gemini-1.5-flash` (エイリアス) を使用

### 【高優先度】エイリアス処理の実装
- バージョン番号を自動追加する処理を削除
- エイリアス名をそのまま使用

### 【中優先度】エラーハンドリングの改善
- モデルが見つからない場合のより詳細な情報提供
- 利用可能なモデル一覧の表示

### 【低優先度】SDKへの移行検討
- 将来的に `@google-cloud/vertexai` SDKの使用を検討

## 5. 正しいモデル指定の考え方

### エイリアス（Alias）とは
- **定義**: 最新バージョンへの参照。バージョン番号を含まない
- **例**: `gemini-1.5-flash`, `gemini-1.5-pro`
- **利点**: モデルの更新に自動的に対応、メンテナンス不要

### バージョン指定とは
- **定義**: 特定のバージョン番号を含む完全なモデル名
- **例**: `gemini-1.5-flash-002`, `gemini-1.5-pro-003`
- **問題点**: バージョンが更新されると動作しなくなる

### REST APIでの扱い
Vertex AI REST APIでは、**エイリアスがサポートされている**ため、バージョン番号なしで使用可能です。

```
✅ 正しい: /models/gemini-1.5-flash:generateContent
❌ 間違い: /models/gemini-1.5-flash-001:generateContent (存在しない可能性)
```

## 6. 再発防止のためのチェックリスト

### 開発前の確認
- [ ] Vertex AI Studioで使用しているモデル名（エイリアス）を確認
- [ ] REST APIドキュメントでモデル名の形式を確認
- [ ] バージョン番号を含めるべきか、エイリアスを使うべきかを判断

### 実装時の確認
- [ ] モデル名にバージョン番号を自動追加しない
- [ ] エイリアス名をそのまま使用する
- [ ] エラーメッセージに実際に試したモデル名を表示

### テスト時の確認
- [ ] Vertex AI Studioとローカル実行で同じモデル名を使用
- [ ] 404エラーが出た場合、モデル名をエイリアスに変更
- [ ] ログで実際に使用しているエンドポイントとモデル名を確認

### ドキュメント更新
- [ ] `.env`のサンプルをエイリアス名に更新
- [ ] コメントでエイリアスとバージョン指定の違いを説明
- [ ] トラブルシューティングガイドにモデル名の問題を追加


